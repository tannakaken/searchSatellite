# searchSatellite

spresenseを使って、カメラに映った人工衛星を見つけてディスプレイに赤い枠をつけて表示し、写真を撮影するスケッチ。言語はarduino。

また画像をシリアル通信で送信する機能と、その際GPSなどのデータを一緒に送信する機能がある。

今回の実装はあくまでデモとspresenseの研究用で、実際の宇宙空間で使用可能なことは目指してはいない。

## 画像検知

spresenseはメモリが小さいので、機械学習モデルは非常に小さなものしか使えない。
よって、機械学習は使わず、敢えて原始的な方法で物体を認識している。

原理としては、カメラからYUV形式で取得した画像データをビット演算でグレイスケール化し、適当な閾値で二値化している。
そして、白が続く最大の横幅及びその開始地点のx座標と、白が続く最大の縦幅及びその開始地点のy座標を計算している。
それによって赤い枠を画像に描いてディスプレイに出力している。

この手法は背景が黒に近いことを仮定している。デモ時は黒い垂れ幕などをカメラの前において、その垂れ幕とカメラの間に、明るい色の物体を通過させること。

物体が正方形に近ければ、正しい枠が描かれるが、例えばブーメラン型の物体だと正しく描けない。

また、画面に映っている明るいもののなかで一番大きなものにのみ枠を描く。

枠を描くとディスプレイのフレームレートは遅くなる。

## GPS

GPSについては、arduinoのspresense用sdkに付属していたサンプルスケッチの中の「gnss」を参考にした。

## シリアル通信

シリアル通信については、最初はバイナリーを送ろうとしたが、うまくいかず（今考えると排他制御の問題だった可能性があるので再挑戦する価値はある）、
base64にエンコードして文字列にして送信した。
base64へのエンコードはhttps://gist.github.com/ksasao/89b2b83df153386026ea69d813fd584eを参考にした。

カメラの処理を行うCamCB関数とシリアル通信のリクエストを処理するloop関数が別のスレッドで並列に動くため、
MPMutexを使って同期させないと送信するデータが壊れる。

# 依存ライブラリー

- Adafruit_ILI9341.h
  - https://github.com/TE-YoshinoriOota/Spresense-LowPower-EdgeAI/tree/main/Libraries からzipをダウンロードしてarduion IDEの機能でインストールする
